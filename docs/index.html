<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>

    <!-- PWA /-->
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.webmanifest">

    <title>Pade - Converse</title>
    <link id="favicon" rel="shortcut icon" type="image/ico" href="css/images/favicon.ico"/>

    <link type="text/css" rel="stylesheet" media="screen" href="dist/converse.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="css/fullpage.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="css/concord.css" />

    <link type="text/css" rel="stylesheet" media="screen" href="content-summary/content.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="directory/directory.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="search/search.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="search/flatpickr.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="browsertab/browsertab.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="location/location.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="pade/pade.css" />

    <script src="dist/libsignal-protocol.js"></script>
    <script src="dist/converse.js"></script>

    <script src="canned-responses/canned.js"></script>
    <script src="screencast/screencast.js"></script>
    <script src="vmsg/vmsg.js"></script>
    <script src="content-summary/content.js"></script>
    <script src="directory/directory.js"></script>
    <script src="search/flatpickr.js"></script>
    <script src="search/search.js"></script>
    <script src="jitsimeet/jitsimeet.js"></script>
    <script src="audioconf/audioconf.js"></script>
    <script src="fastpath/fastpath.js"></script>
    <script src="browsertab/favico.js"></script>
    <script src="browsertab/browsertab.js"></script>
    <script src="pade/webpush-browserify-bundle.js"></script>
    <script src="location/location.js"></script>
    <script src="settings/settings.js"></script>
    <script src="pade/pade.js"></script>

</head>
<body class="reset">
<div class="converse-content" style="display:none">
    <div class="inner-content converse-brand row">
        <div class="converse-brand__padding"></div>
        <div class="converse-brand__heading">
            <div class="converse-brand__text"><i class="icon-conversejs"></i>Converse</div>
            <div class="converse-brand__byline">
                brought to you by <a target="_blank" rel="nofollow" href="https://opkode.com">Opkode</a>
            </div>
        </div>
    </div>
</div>
<div id="conversejs" class="theme-concord"></div>
<script>
    function ready(fn) {
        if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }

    function initConverse()
    {
        var request = new XMLHttpRequest();
        request.open( 'GET', 'config.json', true );

        request.onload = function ()
        {
            if ( request.status >= 200 && request.status < 400 )
            {
                var config = JSON.parse( request.responseText );

                if (window.converse_settings)
                {
                    var localConfig = window.converse_settings.getConfig();

                    const keys = Object.getOwnPropertyNames(localConfig);

                    for (var i=0; i<keys.length; i++)
                    {
                        config[keys[i]] = localConfig[keys[i]];
                        console.debug("Use local saved setting", keys[i], localConfig[keys[i]]);
                    }
                }

                initServiceWorker( config );
            }
            else
            {
                console.error( "We reached our target server, but it returned an error: " + request.status );
            }
        };

        request.onerror = function ( e )
        {
            console.error( "There was a connection error of some sort:" + e );
        };

        request.send();
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    function initServiceWorker(config)
    {
        if ('serviceWorker' in navigator && 'PushManager' in window)
        {
            console.debug('Service Worker and Push is supported', config);

            navigator.serviceWorker.onmessage = function(event) {
                console.debug("Broadcasted from SW : ", event.data);
            };

            navigator.serviceWorker.register('./serviceworker.js').then(function(swRegistration)
            {
                console.debug('Service Worker is registered', swRegistration);

                swRegistration.pushManager.getSubscription().then(function(subscription)
                {
                    if (subscription && !localStorage["pade.vapid.keys"])
                    {
                        subscription.unsubscribe();
                        subscription = null;
                    }

                    if (!subscription) {
                        const keys = window.WebPushLib.generateVAPIDKeys();
                        console.debug('Service Worker new subscription keys', keys);

                        swRegistration.pushManager.subscribe({userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(keys.publicKey)}).then(function(subscription)
                        {
                            console.debug('User is subscribed.');
                            localStorage["pade.vapid.keys"] = JSON.stringify(keys);
                            handleSubscription(config, subscription, keys);

                        }).catch(function(err) {
                            console.debug('Failed to subscribe the user: ', err);
                            converse.initialize( config )
                        });
                    }
                    else {
                        handleSubscription(config, subscription, JSON.parse(localStorage["pade.vapid.keys"]));
                    }

                }).catch(function(error) {
                    console.debug('Error unsubscribing', error);
                    converse.initialize( config )
                });

            }).catch(function(error) {
                console.error('Service Worker Error', error);
                converse.initialize( config )
            });
        } else {
            console.warn('Push messaging is not supported');
            converse.initialize( config )
        }
    }

    function handleSubscription(config, subscription, keys)
    {
        console.debug('handleSubscription', config, subscription, keys);

        const secret = btoa(JSON.stringify({privateKey: keys.privateKey, publicKey: keys.publicKey, subscription: subscription}));
        if (secret) config.push_app_servers = [{'jid': config.domain_placeholder, 'node': 'webpush', 'secret': secret}];
        converse.initialize( config )

        window.WebPushLib.setVapidDetails('xmpp:' + config.domain_placeholder, keys.publicKey, keys.privateKey);
        window.WebPushLib.selfSubscription = JSON.parse(JSON.stringify(subscription));
    }
    ready( initConverse );
</script>
</body>
</html>
